<%= form_for(@deal, html: { id: "address_form" }, remote: true, multipart: true ) do |f| %>
  
  <header class="header bg-white b-b clearfix p-md">
    <div class="row">
      <div class="col-sm-4">
        
      </div>
      <div class="col-sm-4">
        <% if Rails.env.development? %>
        50% complete
        <div class="progress progress-xs" style="margin:0"> 
          <div class="progress-bar bg-info" data-toggle="tooltip" data-original-title="50%" style="width: 50%">
          </div> 
        </div>
        <% end %>
      </div>
      <div class="col-sm-4 text-right">
        <a href="" class="btn btn-default" id="continue-btn">Continue</a>
      </div>
    </div>
  </header>
  <section class="scrollable wrapper w-f">
    <div class="panel-body">
      <div class="add-page">
        <div class="row">
          <div class="col-md-8 col-md-offset-2">
            <% if @deal.errors.any? %>
              <div id="error_explanation">
                <h2><%= pluralize(@deal.errors.count, "error") %> prohibited this deal from being saved:</h2>
                <ul>
                <% @deal.errors.full_messages.each do |msg| %>
                  <li><%= msg %></li>
                <% end %>
                </ul>
              </div>
            <% end %>
            <h1>Upload Photos</h1>
            <div class="parent" id="display-none-preview">
              <%= link_to_add_fields "Add Image", f, :image_galleries %>
              <script type="text/javascript">
                $(".parent > a").addClass('btn btn-default btn-square').html('<i class="i i-images"></i><br> Add Images<br> JPG, PNG');
              </script>
              <%= f.fields_for :image_galleries do |builder| %>
                <% if builder.object.new_record? %>
                  <%= render 'image_gallery_fields', :f => builder %>
                <% end %>
              <% end %>

            <%= f.fields_for :image_galleries do |builder| %>
              <% unless builder.object.new_record? %>
                <div class="preview-col">
                  <div class="fields">
                    <%= image_tag(builder.object.deal_images.url(:thumb), id: "uploadimage", class: "img-thumbnail gallery") %>
                    <div class="row">
                      <div class="col-md-12">
                        <div class="btn-group waky" data-toggle="buttons">
                          <label class="btn btn-default btn-sm m-b-lg">
                            <%= builder.check_box :_destroy %><i class="fa fa-trash-o"></i>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
            </div><!-- end parent -->
           
            <div class="actions">
              <%= f.submit "Save", class: "btn btn-success", style: "" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</section>
<script>
  $(document).ready(function() {

    $('input').change(function() {

      $('#address_form').submit(); 
      $('#feedback').show();     
      $('#feedback').text("saved").fadeOut('slow');

    });

    

    $('#continue-btn').click(function() {
      $('#address_form').submit(); 
    });

    $('.nav-main li a').click(function() {
      $('#address_form').submit();
    });

    
   

  });

  function add_fields(link, association, content) {
        var new_id = new Date().getTime();
        var regexp = new RegExp("new_" + association, "g");
        $(link).parent().append(content.replace(regexp, new_id));
        var id = "deal_image_galleries_attributes_" + new_id + "_deal_images";
        
        // File submit gets clicked automatically after Add Image btn is clicked on Availability page
        $("#" + id).click();
        $(".parent > .preview-col:last").hide();
        $(".parent > .preview-col > .fields > .upload-preview:last img").addClass(id);
   

        // Preview image on Upload Photos page before submit
        var preview = $(".upload-preview img." + id);
        // File input change on Availability page
        $("#" + id).change(function(event){
            var input = $(event.currentTarget);
            var file = input[0].files[0];
            var reader = new FileReader();

            reader.onload = function(e){
                image_base64 = e.target.result;
                preview.attr("src", image_base64);
            };

            reader.readAsDataURL(file);  

            preview.addClass('preview-img-border');
           $(".parent > .preview-col:last").show();
        });     

        

    }
</script>
<style type="text/css">
#display-none-preview > .preview-col:first-of-type {
  width: 0px;
}
#display-none-preview > .preview-col:first-of-type > .fields > .upload-preview,
#display-none-preview > .preview-col:first-of-type > .fields > .row > .col-md-12 > .btn-group {
  display: none;
  width: 0px;
}
</style>





























